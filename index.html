<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR-Code Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Menüleiste -->
    <header>
        <button id="menuButton">☰ Menü</button>
        <img src="Logo entwurf1.jpg" alt="Logo entwurf1" id="headerImage">
    </header>

    <!-- Kamera öffnen Hinweis -->
    <main>
        <div class="Text-container">
            <p>VU mit mehreren PKW und Personen. Bei Eintreffen an der Einsatzstelle zeigt sich ein Szenario von mehreren Verletzten. Diese können im und um din PKW verteilen.
                 Die Einsatzstelle ist momentan keinen weiteren Gefahren ausgesetzt und man kann die Einsatzstelle begehen. 
                 Weiteres vorgehen nach eigenen Vorgaben.</p>
        </div>
        <div class="camera-container">
            <button id="cameraButton">Patienten scannen</button>
        </div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </main>

    <!-- Modal für Menü -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Menü</h2>
            <ul>
                <li><a href="patient1.html">Patient1</a></li>
                <li><a href="patient2.html">Patient2</a></li>
                <li><a href="patient3.html">Patient3</a></li>
                <li><a href="patient4.html">Patient4</a></li>
                <li><a href="patient5.html">Patient5</a></li>
                <li><a href="patient6.html">Patient6</a></li>
                <li><a href="patient7.html">Patient7</a></li>
                <li><a href="Einstellungen.html">Einstellungen</a></li>
                <li><a href="#about">Über uns</a></li>
            </ul>
        </div>
    </div>

    <!-- Button zum Zurück zur Startseite -->
    <button id="backToIndex" class="back-button">Zurück zur Startseite</button>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cameraButton = document.getElementById("cameraButton");
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const canvasContext = canvas.getContext('2d');
            const menuButton = document.getElementById("menuButton");
            const menuModal = document.getElementById("menuModal");
            const closeButton = document.querySelector(".close");

            // Menü öffnen und schließen
            menuButton.onclick = function() {
                menuModal.style.display = "block";
            };
            closeButton.onclick = function() {
                menuModal.style.display = "none";
            };
            window.onclick = function(event) {
                if (event.target == menuModal) {
                    menuModal.style.display = "none";
                }
            };

            // Kamera starten
            cameraButton.onclick = async function() {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert("Die Kamera-API wird von diesem Gerät nicht unterstützt.");
                        return;
                    }

                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" } // Rückkamera bevorzugt
                    });

                    video.srcObject = stream;

                    // Warten, bis das Video bereit ist
                    video.onloadedmetadata = () => {
                        video.play();
                        startQRCodeDetection();
                    };

                    // Video in den Vordergrund stellen und auf Vollbild setzen
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100vw';
                    video.style.height = '100vh';
                    video.style.zIndex = '9999'; // Video ganz vorne

                    // Den Rest der Seite unsichtbar machen (optional)
                    document.querySelector('header').style.display = 'none';
                    document.querySelector('main').style.display = 'none';
                } catch (error) {
                    console.error("Kamera-Zugriff fehlgeschlagen:", error);
                    alert("Kamera-Zugriff fehlgeschlagen. Bitte Berechtigungen prüfen.");
                }
            };

            // QR-Code-Erkennung im Video-Stream
            function startQRCodeDetection() {
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;

                // Setzt die Größe des Canvas auf die Video-Größe
                canvas.width = videoWidth;
                canvas.height = videoHeight;

                // Funktion zur kontinuierlichen QR-Code-Erkennung
                const scanQRCode = () => {
                    // Zeichnet das aktuelle Video-Frame in das Canvas
                    canvasContext.drawImage(video, 0, 0, videoWidth, videoHeight);

                    // Holt die Bilddaten vom Canvas
                    const imageData = canvasContext.getImageData(0, 0, videoWidth, videoHeight);

                    // QR-Code-Erkennung mit jsQR
                    const code = jsQR(imageData.data, videoWidth, videoHeight, {
                        inversionAttempts: "dontInvert"
                    });

                    // Wenn ein QR-Code erkannt wird
                    if (code) {
                        alert("QR-Code erkannt! Weiterleitung...");
                        window.location.href = code.data;  // Weiterleitung zur URL im QR-Code
                    } else {
                        requestAnimationFrame(scanQRCode);  // Fortsetzung des Scan-Versuchs
                    }
                };

                requestAnimationFrame(scanQRCode); // Starte das kontinuierliche Scannen
            }

            // Weiterleitung zur Index-Seite, wenn der Button geklickt wird
            document.getElementById("backToIndex").onclick = function() {
                window.location.href = "index.html";  // Weiterleitung zur Index-Seite
            };
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <!-- CSS -->
    <style>
        /* Basislayout */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
            background-color: #d3d3d3;
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #52576e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #menuButton {
            font-size: 1.5em;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            position: absolute;
            left: 20px;
        }

        #headerImage {
            height: 60px;
        }

        main {
            margin-top: 20px;
            text-align: center;
            width: 100%;
        }

        .Text-container { 
            margin-bottom: 20px;
            font-size: 1.1em;
            color: white; /* Weißer Text */
            padding: 10px;
            border: 2px solid #f71717; /* Rahmen mit passender Farbe */
            border-radius: 10px; /* Abgerundete Ecken */
            background-color: #291a1a; /* Hintergrundfarbe für den Textbereich */
            width: 80%;
            max-width: 600px;
            transition: all 0.3s ease; /* Übergangseffekt bei Hover */
        }

        .Text-container:hover {
            background-color: #52576e; /* Hintergrundfarbe beim Hover */
            color: #fff; /* Textfarbe beim Hover */
            transform: scale(1.05); /* Leicht vergrößern beim Hover */
        }

        .camera-container {
            background-color: #d3d3d3;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
        }

        #cameraButton {
            padding: 25px 45px;
            font-size: 2em;
            background-color: rgb(75, 78, 119);
            color: white;
            border: none;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            cursor: pointer;
        }

        video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }

        /* Button für Zurück zur Startseite */
        .back-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            font-size: 1.2em;
            background-color: rgb(75, 78, 119);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .back-button:hover {
            background-color: rgb(60, 63, 93);
        }
    </style>

</body>
</html>
